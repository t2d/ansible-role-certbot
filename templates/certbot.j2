#! /bin/bash
# vim: tabstop=2 expandtab shiftwidth=2 softtabstop=2 smartindent nu

set -e
set -u

{% for certname, certdata in certbot__certs.iteritems() %}

#{{ certname }}
if [ ! -f /etc/letsencrypt/live/{{ certname }}/cert.pem ]; then
  CERTBOTARGS=""
  {% for webroot, domlist in certdata.iteritems() -%}
  CERTBOTARGS="$CERTBOTARGS -w {{ webroot }} -d {{ domlist | join(',') }}"
  {% endfor -%}
  {{ certbot__bin }} certonly {{ certbot__args | join(' ') }} --webroot --cert-name {{ certname }} $CERTBOTARGS
fi

{% endfor %}
